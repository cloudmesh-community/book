<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="../../../assets/css/common_clean.css" media="all" rel="stylesheet" type="text/css"/>
    <script src="../../../assets/scripts/respond.min.js" type="text/javascript"></script>
    <link href="../../../assets/images/favicon.ico" rel="icon" type="image/x-icon"/>
    <title>Singularity Tutorial</title>
    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-941716-1', 'auto');
ga('send', 'pageview');
    </script>
</head>
<body>

<!-- Header -->
<div id="header"><!-- Header --><header role="heading"><!-- Print Logo --><img id="printlogo" src="../../../assets/images/logos/sdsclogo-plusname-horiz-red.jpg"/>
<div data-header="">
<div data-inner=""><!-- Logo --><a href="/" id="logo" title="Click here to return to the Site homepage"><img alt="" height="40" src="../../../assets/images/logo-white.png" width="332"/></a> <!-- Skip to Nav --> <a data-nostyle="" href="#nav-primary">Skip to navigation</a> <!-- Search -->
<p data-nostyle="">Search The Site:</p>
<div id="header-search">
<script type="text/javascript">// <![CDATA[
(function() {
    var cx = '004525422354172179820:4mhelr6k6cm';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
// ]]></script>
<div id="gsearch"></div>
<script type="text/javascript">// <![CDATA[
var gcseSDiv = document.getElementById('gsearch');
   gcseSDiv.innerHTML = '<gcse:search></gcse:search>';
// ]]></script>
</div>
<nav role="navigation">
<p data-nostyle="">Site 'Primary' Navigation:</p>
</nav><nav role="navigation">
<div id="ucsd_logo" style="border-bottom: 1px solid white; float: right; width: 104px; height: 20px; margin-right: 3%;"><a href="http://www.ucsd.edu" rel="noopener" target="_blank"><img alt="UCSD logo" height="20" src="../../../assets/images/ucsd-logo-white.png" width="104"/></a></div>
<ul data-nav="" id="nav-tertiary" style="margin-top: 0.2rem;">
<li><a href="https://intranet.sdsc.edu/" rel="noopener" target="_blank">Intranet</a></li>
<li><a href="../../status.html">Datacenter Status</a></li>
<li><a href="/cgi-bin/staff_dir.cgi">Directory</a></li>
</ul>
</nav>
<p class="nav-headline">DATA to DISCOVERY</p>
<p data-nostyle="">Site 'Primary' Navigation:</p>
<ul data-nav="" id="nav-primary">
<li><a href="../../../services/index.html">Services</a>
<ul class="nav2">
<li><a href="../../../services/hpc/index.html">High-Performance Computing</a>
<ul class="nav3">
<li><a href="../../../services/hpc/applications.html">Applications</a></li>
<li><a href="../../../services/hpc/hpc_systems.html">HPC Systems</a></li>
<li><a href="../../../services/hpc/parallel_file_systems.html">Parallel File Systems</a></li>
<li><a href="../../../services/hpc/parallelization.html">Parallelization &amp; Code Optimization</a></li>
<li><a href="../../../services/hpc/performance_modeling.html">Performance Modeling</a></li>
<li><a href="../../../services/hpc/science_gateways.html">Science Portals/Gateways</a></li>
<li><a href="../../../services/hpc/visualization.html">Visualization</a></li>
</ul>
</li>
<li><a href="../../../services/data_science/index.html">Data Science Solutions</a>
<ul class="nav3">
<li><a href="../../../services/data_science/big_data_benchmarking.html">Big Data Benchmarking</a></li>
<li><a href="../../../services/data_science/data_info_virtualization.html">Data &amp; Information Virtualization</a></li>
<li><a href="../../../services/data_science/data_integration.html">Data Integration</a></li>
<li><a href="../../../services/data_science/data_modeling.html">Data Modeling, Design &amp; Optimization</a></li>
<li><a href="../../../services/data_science/graph_analytics.html">Graph Analytics</a></li>
<li><a href="../../../services/data_science/spatial_data.html">Spatial Data</a></li>
<li><a href="../../../services/data_science/statistics.html">Statistics, Machine Learning &amp; Predictive Analytics</a></li>
<li><a href="../../../services/data_science/time_series.html">Time Series &amp; Streaming Data</a></li>
<li><a href="../../../services/hpc/visualization.html">Visualization</a></li>
</ul>
</li>
<li><a href="../../../services/ci/index.html">Cyberinfrastructure Services</a>
<ul class="nav3">
<li><a href="../../../services/ci/cloud.html">Cloud Storage &amp; Compute</a></li>
<li><a href="../../../services/ci/colocation.html">Colocation</a></li>
<li><a href="../../../services/ci/cybersecurity.html">Cybersecurity/Security Consulting</a></li>
<li><a href="../../../services/ci/enterprise_networking.html">Enterprise Networking</a></li>
<li><a href="../../../services/ci/hipaa_fisma.html">HIPAA &amp; FISMA Compliant Solutions</a></li>
<li><a href="../../../services/ci/research_data_consulting.html">Research Data Consulting</a></li>
<li><a href="../../../services/ci/storage_backups.html">Storage: Backups</a></li>
<li><a href="../../../services/ci/storage_nfs.html">Storage: Project</a></li>
<li><a href="../../../services/ci/systems_admin.html">UNIX &amp; Windows System Administration</a></li>
<li><a href="../../../services/ci/vmware.html">VMware Virtualization Hosting</a></li>
<li><a href="../../../services/ci/web_db_hosting.html">Web/DB Hosting &amp; Design</a></li>
</ul>
</li>
<li><a href="../../../services/business_services/index.html">Business Services</a>
<ul class="nav3">
<li><a href="../../../services/business_services/business_applications.html">Business Application Development</a></li>
<li><a href="../../../services/business_services/conference_facilities.html">Conference Facilities</a></li>
</ul>
</li>
</ul>
</li>
<!--support menu(start)-->
<li><a href="../../index.html">Support</a>
<ul class="nav3">
<li><a href="../../accounts_allocations.html">Accounts &amp; Allocations</a></li>
<li><a href="../../resource_docs.html">Resource Documentation</a></li>
<li><a href="../../technical_support.html">Technical Consulting</a></li>
<li><a href="../../status.html">System News &amp; Status</a></li>
</ul>
</li>
<!--support menu(end)--><!--Research & Development menu(start)-->
<li><a href="../../../research/index.html">Research &amp; Development</a>
<ul class="nav3">
<li><a href="../../../research/centers_of_excellence.html">Centers of Excellence</a></li>
<li><a href="../../../research/groups_labs_projects.html">Groups, Labs, &amp; Projects</a></li>
<li><a href="../../../research/collaboration.html">Collaboration</a></li>
</ul>
</li>
<!--Research & Development menu(end)--><!--Education & Training(start)-->
<li><a href="../../../education_and_training/index.html">Education &amp; Training</a>
<ul class="nav3">
<li><a href="../../../education_and_training/camps_workshops.html">Camps &amp; Workshops</a></li>
<li><a href="../../../education_and_training/courses_degrees.html">Courses &amp; Degree Programs</a></li>
<li><a href="../../../education_and_training/training.html">Advanced Computing Training</a></li>
<li><a href="../../../education_and_training/webinars.html">Webinars</a></li>
<li><a href="../../../education_and_training/internships.html">Internships</a></li>
</ul>
</li>
<!--Education & Training(end)--><!--News & Events(start)-->
<li><a href="../../../news_and_events/index.html" title="News and Events">News &amp; Events</a>
<ul class="nav3">
<li><a href="../../../news_and_events/news_list_recent.html" title="Press Releases">Press Releases</a></li>
<li><a href="../../../news_and_events/events.html" title="Events">Events</a></li>
<li><a href="../../../news_and_events/in_the_news.html">In The News</a></li>
<li><a href="../../../news_and_events/newsletter.html">Newsletter</a></li>
<li><a href="../../../news_and_events/meet_the_experts.html">"Meet The Experts"</a></li>
<li><a href="../../../pub/index.html" title="Publications">Publications</a></li>
<li><a href="../../../news_and_events/press_kit.html">Press Kit</a></li>
</ul>
</li>
<!--News & Events(end)--><!--About SDSC(start)-->
<li><a href="../../../about_sdsc/index.html">About SDSC</a>
<ul class="nav3">
<li><a href="../../../about_sdsc/overview.html">Overview</a></li>
<li><a href="../../../assets/docs/pub/sdsc_timeline_web.pdf" rel="noopener" target="_blank">Timeline</a></li>
<li><a href="../../../about_sdsc/director.html">About the Director</a></li>
<li><a href="../../../about_sdsc/contacts_leadership.html">Contacts &amp; Leadership</a></li>
<li><a href="/cgi-bin/staff_dir.cgi">Staff Directory</a></li>
<li><a href="../../../about_sdsc/careers.html">Careers</a></li>
<li><a href="../../../about_sdsc/visitor_info.html">Visitor Info</a></li>
</ul>
</li>
<!--About SDSC(end)--></ul>
</div>
</div>
</header></div>

<div data-content="">
    <div data-layout="">

        <!-- Breadcrumbs -->
        <div data-breadcrumbs="" data-inner=""><ul id="nav-breadcrumbs"><li><a href="/">Home</a> &gt;
						</li><li><a href="../../index.html">Support</a> &gt;
										</li><li>Singularity Tutorial</li></ul></div>

        <!-- Content -->
        <div data-row="2" id="sub-content">
            <div data-inner="">
                <!--[if lte IE 7]>
                    <p data-chromeframe>You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/" target="_blank">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true" target="_blank">activate Google Chrome Frame</a> to improve your experience.</p>
                <![endif]-->
                <div data-col="2" id="user_guide_toc">
                    <div class="section">
                        
                    </div>
                    <div class="section">
                        
                    </div>
                </div>
                <section role="document"><div data-col="1"><h1>Running Singularity Containers on Comet</h1>
<div section="class">
<div section="class"><a name="background"></a>
<h2>Background</h2>
<p>What is Singularity?*</p>
<p><em>"Singularity enables users to have full control of their environment. Singularity containers can be used to package entire scientific workflows, software and libraries, and even data. This means that you don&#8217;t have to ask your cluster admin to install anything for you - you can put it in a Singularity container and run."</em></p>
<h5>[*from the Singularity web site at <a href="http://singularity.lbl.gov/" rel="noopener" target="_blank">http://singularity.lbl.gov/</a>]</h5>
<p>There are numerous good tutorials on how to install and run Singularity on Linux, OS X, or Windows so we won't go into much detail on that process here. In this tutorial you will learn how to run Singularity on Comet. First we will review how to access a compute node on Comet and provide a simple example to help get you started. There are numerous tutorial on how to get started with Singularity, but there are some details specific to running Singularity on Comet which are not covered in those tutorials. This tutorial assumes you already have an account on Comet. You will also need access to a basic set of example files to get started. SDSC hosts a Github repository containing a &#8216;Hello world!&#8221; example which you may clone with the following command:</p>
<p>&gt; git clone https://github.com/hpcdevops/singularity-hello-world.git</p>
<h2>Tutorial Contents</h2>
<ul>
<li>Why Singularity?</li>
<li>Downloading &amp; Installing Singularity</li>
<li>Building Singularity Containers</li>
<li>Running Singularity Containers on Comet</li>
<li>Running Tensorflow on Comet Using Singularity</li>
</ul>
<h1>Why Singularity?</h1>
<p>Below is a typical list of commands you would need to issue in order to implement a functional Python installation for scientific research:</p>
<p><code>COMMAND=apt-get -y install libx11-dev <br/> COMMAND=apt-get install build-essential python-libdev <br/> COMMAND=apt-get install build-essentyial openmpi-dev <br/> COMMAND=apt-get install cmake<br/> COMMAND=apt-get install g++ <br/> COMMAND=apt-get install git-lfs <br/> COMMAND=apt-get install libXss.so.1<br/> COMMAND=apt-get install libgdal1-dev libproj-dev <br/> COMMAND=apt-get install libjsoncpp-dev libjsoncpp0 <br/> COMMAND=apt-get install libmpich-dev --user<br/> COMMAND=apt-get install libpthread-stubs0 libpthread-stubs0-dev libx11-dev libx11-d <br/> COMMAND=apt-get install libudev0:i386<br/> COMMAND=apt-get install numpy <br/> COMMAND=apt-get install python-matplotlib <br/> COMMAND=apt-get install python3</code></p>
<p>Singularity allows you to avoid this time-consuming series of steps by packaging these commands in a re-usable and editable script, allowing you to quickly, easily, and repeatedly implement a custom container designed specifically for your analytical needs.</p>
<p>The diagram below compares a VM vs. Docker vs. Singularity.</p>
<p><img height="248" src="http://education.sdsc.edu/comet/index_clip_image002.png" width="468"/></p>
<h5>Source:&#194; <a href="http://www.hpcadvisorycouncil.com/events/2017/stanford-workshop/pdf/GMKurtzer_Singularity_Keynote_Tuesday_02072017.pdf#43">Greg Kurtzer keynote at HPC Advisory Council 2017 @ Stanford</a></h5>
<p>&#160;</p>
<h1>Hands-On Tutorials</h1>
<p><img alt="" class="video_icon" height="90" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="117"/>Next, let's get some hands-on experience with Singularity. The following tutorial includes links to asciinema video tutorials created by SDSC HPC Systems Manager, Trevor Cooper (Thanks, Trevor!) which allow you to see the console interactivity and output in detail. Look for the video icon like the one shown to the right corresponding to the task you are currently working on.</p>
<h1><a name="downloading"></a></h1>
<h1>Downloading &amp; Installing Singularity</h1>
<ul>
<li>Download &amp; Unpack Singularity</li>
<li>Configure &amp; Build Singularity</li>
<li>Install &amp; Test Singularity</li>
</ul>
<p>&#160;</p>
<h2>Download &amp; Unpack Singularity</h2>
<p>First we download and upack the source using the following commands (assuming your user name is 'test_user' and you are working on your local computer with super user privileges):</p>
<p><code>[test_user@localhost &#126;]$ wget https://github.com/singularityware/singularity/<br/> releases/download/2.5.1/singularity-2.5.1.tar.gz</code> <code>tar -zxf singularity-2.5.1.tar.gz</code><a href="https://asciinema.org/a/129866" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a></p>
<p>If the file is successfully extracted, you should be able to view the results:</p>
<code>[test_user@localhost &#126;]$ cd singularity-2.5.1/<br/> [test_user@localhost singularity-2.5.1]$ ls</code>
<h2>&#160;</h2>
<h2>Configure &amp; Build Singularity</h2>
<p><a href="https://asciinema.org/a/129867" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Next we configure and build the package. To configure, enter the following command (we will leave out the command prompts):</p>
<code>./configure</code>
<p>To build, issue the following command:</p>
<code>make</code>
<p>This may take several seconds depending on your computer.</p>
<h2>Install &amp; Test Singularity</h2>
<p><a href="https://asciinema.org/a/129868" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>To complete the installation enter:</p>
<code>sudo make install</code>
<p>You should be prompted to enter your admin password.</p>
<p>Once the installation is completed, you can check to see if it succeeded in a few different ways:</p>
<code>which singularity</code> <code>singularity -version</code>
<p>You can also run a selftest with the following command:</p>
<code>singularity selftest</code>
<p>The output should look something like:</p>
<code>+ sh -c test -f /usr/local/etc/singularity/singularity.conf (retval=0) OK <br/> + test -u /usr/local/libexec/singularity/bin/action-suid (retval=0) OK <br/> + test -u /usr/local/libexec/singularity/bin/create-suid (retval=0) OK <br/> + test -u /usr/local/libexec/singularity/bin/expand-suid (retval=0) OK <br/> + test -u /usr/local/libexec/singularity/bin/export-suid (retval=0) OK <br/> + test -u /usr/local/libexec/singularity/bin/import-suid (retval=0) OK <br/> + test -u /usr/local/libexec/singularity/bin/mount-suid (retval=0) OK<br/> </code>
<p><a name="building_singularity_containers"></a></p>
<h1>Building Singularity Containers</h1>
<p>The process of building a Singularity container consists of a few distinct steps as follows.</p>
<ul>
<li>Upgrading Singularity (if needed)</li>
<li>Create an Empty Container</li>
<li>Import into Container</li>
<li>Shell into Container</li>
<li>Write into Container</li>
<li>Bootstrap Container</li>
</ul>
<p>&#160;</p>
<p>We will go through each of these steps in detail.</p>
<h2>Upgrading Singularity</h2>
<p>We recommend building containers using the same version of Singularity, 2.5.1, as exists on Comet. This is a 2 step process.</p>
<p><strong>Step 1: run the script below to remove your existing Singularity:</strong></p>
<p><span>#!/bin/bash</span><br/><span>#</span><br/><span># A cleanup script to remove Singularity</span><br/><br/><span>sudo rm -rf /usr/local/libexec/singularity</span><br/><span>sudo rm -rf /usr/local/etc/singularity</span><br/><span>sudo rm -rf /usr/local/include/singularity</span><br/><span>sudo rm -rf /usr/local/lib/singularity</span><br/><span>sudo rm -rf /usr/local/var/lib/singularity/</span><br/><span>sudo rm /usr/local/bin/singularity</span><br/><span>sudo rm /usr/local/bin/run-singularity</span><br/><span>sudo rm /usr/local/etc/bash_completion.d/singularity</span><br/><span>sudo rm /usr/local/man/man1/singularity.1</span></p>
<p><strong>Step 2: run the following script to install Singularity 2.5.1:</strong></p>
<p><span><span>#!/bin/bash</span><br/><span>#</span><br/><span># A build script for Singularity (http://singularity.lbl.gov/)</span><br/><br/><span>declare -r SINGULARITY_NAME='singularity'</span><br/><span>declare -r SINGULARITY_VERSION='2.5.1'</span><br/><span>declare -r SINGULARITY_PREFIX='/usr/local'</span><br/><span>declare -r SINGULARITY_CONFIG_DIR='/etc'</span><br/><br/><span>sudo apt update</span><br/><span>sudo apt install python dh-autoreconf build-essential debootstrap</span><br/><br/><span>cd ../</span><br/><span>tar -xzvf "${PWD}/tarballs/${SINGULARITY_NAME}-${SINGULARITY_VERSION}.tar.gz"</span><br/><span>cd "${SINGULARITY_NAME}-${SINGULARITY_VERSION}"</span><br/><span>./configure --prefix="${SINGULARITY_PREFIX}" --sysconfdir="${SINGULARITY_CONFIG_DIR}"</span><br/><span>make</span><br/><span>sudo make install</span></span></p>
<p>&#160;</p>
<h2>Create an Empty Container</h2>
<p><a href="https://asciinema.org/a/130106" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>To create an empty Singularity container, you simply issue the following command:</p>
<code>singularity create centos7.img</code>
<p>This will create a CentOS 7 container with a default size of &#126;805 Mb. Depending on what additional configurations you plan to make to the container, this size may or may not be big enough. To specify a particular size, such as &#126;4 Gb, include the -s parameter, as shown in the following command:</p>
<code>singularity create -s 4096 centos7.img</code>
<p>To view the resulting image in a directory listing, enter the following:</p>
<code>ls</code>
<h2>Import Into a Singularity Container</h2>
<p><a href="https://asciinema.org/a/130107" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Next, we will import a Docker image into our empty Singularity container:</p>
<code>singularity import centos7.img docker://centos:7</code>
<p>&#160;</p>
<h2>Shell Into a Singularity Container</h2>
<p><a href="https://asciinema.org/a/130109" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Once the container actually contains a CentOS 7 installation, you can &#8216;shell&#8217; into it with the following:</p>
<code>singularity shell centos7.img</code>
<p>Once you enter the container you should see a different command prompt. At this new prompt, try typing:</p>
<code>whoami </code>
<p>Your user id should be identical to your user id outside the container. However, the operating system will probably be different. Try issuing the following command from inside the container to see what the OS version is:</p>
<code>cat /etc/*-release</code>
<h2>Write Into a Singularity Container</h2>
<p><a href="https://asciinema.org/a/130110" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Next, let&#8217;s trying writing into the container (as root):</p>
<code>sudo /usr/local/bin/singularity shell -w centos7.img</code>
<p>You should be prompted for your password, and then you should see something like the following:</p>
<code>Invoking an interactive shell within the container...</code>
<p>Next, let&#8217;s create a script within the container so we can use it to test the ability of the container to execute shell scripts:</p>
<code>vi hello_world.sh</code>
<p>The above command assumes you know the vi editor. Enter the following text into the script, save it, and quit the vi editor:</p>
<code>#!/bin/bash<br/> echo &#8220;Hello, World!&#8221;</code>
<p>You may need to change the permissions on the script so it can be executable:</p>
<code>chmod +x hello_world.sh</code>
<p>Try running the script manually:</p>
<code>./hello_world.sh</code>
<p>The output should be:</p>
<code>Hello, World!</code>
<p>&#160;</p>
<h2>Bootstrapping a Singularity Container</h2>
<p><a href="https://asciinema.org/a/130111" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Bootstrapping a Singularity container allows you to use what is called a &#8216;definitions file&#8217; so you can reproduce the resulting container configurations on demand.</p>
<p>Let&#8217;s say you want to create a container with Ubuntu, but you may want to create variations on the configurations without having to repeat a long list of commands manually. First, we need our definitions file. Below is the contents of a definitions file which should suffice for our purposes.</p>
<code>Bootstrap: docker<br/> From: ubuntu:latest</code>
<p><code>%runscript</code><br/> <code>exec echo &#8220;The runscript is the containers default runtime command!&#8221;</code></p>
<p><code>%files<br/> /home/testuser/ubuntu.def /data/ubuntu.def</code></p>
<code>%environment<br/> VARIABLE=HELLOWORLD<br/> Export VARIABLE </code>
<p><code>%labels<br/> AUTHOR testuser@sdsc.edu</code></p>
<p><code>%post<br/> apt-get update &amp;&amp; apt-get -y install python3 git wget<br/> mkdir /data<br/> echo &#8220;The post section is where you can install and configure your container.&#8221;</code></p>
<p>To bootstrap your container, first we need to create an empty container.</p>
<code>singularity create -s 4096 ubuntu.img</code>
<p>Now, we simply need to issue the following command to configure our container with Ubuntu:</p>
<code>sudo /usr/local/bin/singularity bootstrap ./ubuntu.img ./ubuntu.def</code>
<p>This may take a while to complete. In principle, you can accomplish the same result by manually issuing each of the commands contained in the script file, but why do that when you can use bootstrapping to save time and avoid errors.</p>
<p>If all goes according to plan, you should then be able to shell into your new Ubuntu container.</p>
<p><a name="running_singularity_containers"></a></p>
<h1>Running Singularity Containers on Comet</h1>
<p>Of course, the purpose of this tutorial is to enable you to use the San Diego Supercomputer Center&#8217;s Comet supercomputer to run your jobs. This assumes you have an account on Comet already. If you do not have an account on Comet and you feel you can justify the need for such an account (i.e. your research is limited by the limited compute power you have in your government-funded research lab), you can request a &#8216;Startup Allocation&#8217; through the XSEDE User Portal:</p>
<p><a href="https://portal.xsede.org/allocations-overview#types-trial">https://portal.xsede.org/allocations-overview#types-trial</a></p>
<p>You may create a free account on the XUP if you do not already have one and then proceed to submit an allocation request at the above link.</p>
<p>[NOTE: SDSC provides a Comet User Guide ( <a href="http://www.sdsc.edu/support/user_guides/comet.html">http://www.sdsc.edu/support/user_guides/comet.html</a> ) to help get you started with Comet. Learn more about The San Diego Supercomputer Center at <a href="http://www.sdsc.edu">http://www.sdsc.edu</a> .]</p>
<p>This tutorial walks you through the following four steps towards running your first Singularity container on Comet:</p>
<ul>
<li>Transfer the Container to Comet</li>
<li>Run the Container on Comet</li>
<li>Allocate Resources to Run the Container</li>
<li>Integrate the Container with Slurm</li>
<li>Use existing Comet Containers</li>
</ul>
<p>&#160;</p>
<h2>Transfer the Container to Comet</h2>
<p><a href="https://asciinema.org/a/130195" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Once you have created your container on your local system, you will need to transfer it to Comet. There are multiple ways to do this and it can take a varying amount of time depending on its size and your network connection speeds.</p>
<p>To do this, we will use scp (secure copy). If you have a Globus account and your containers are more than 4 Gb you will probably want to use that file transfer method instead of scp.</p>
<p>Browse to the directory containing the container. Copy the container to your scratch directory on Comet. By issuing the following command:</p>
<code>scp ./centos7.img comet.sdsc.edu:/oasis/scratch/comet/test_user/temp_project/</code>
<p>The container is &#126;805 Mb so it should not take too long, hopefully.</p>
<p>&#160;</p>
<h2>Run the Container on Comet</h2>
<p><a href="https://asciinema.org/a/130196" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Once the file is transferred, login to Comet (assuming your Comet user is named 'test_user'):</p>
<code>ssh test_user@comet.sdsc.edu</code>
<p>Navigate to your scratch directory on Comet, which should be something like:</p>
<code>[test_user@comet-ln3 &#126;]$ cd /oasis/scratch/comet/test_user/temp_project/</code>
<p>Next, you should submit a request for an interactive session on one of Comet&#8217;s compute, debug, or shared nodes.</p>
<code>[test_user@comet-ln3 &#126;]$ srun --pty --nodes=1 --ntasks-per-node=24 -p compute -t 01:00:00 --wait 0 /bin/bash </code>
<p>Once your request is approved your command prompt should reflect the new node id.</p>
<p>Before you can run your container you will need to load the Singularity module (if you are unfamiliar with modules on Comet, you may want to review the Comet User Guide). The command to load Singularity on Comet is:</p>
<code>[test_user@comet-ln3 &#126;]$ module load singularity</code>
<p>You may issue the above command from any directory on Comet. Recall that we added a hello_world.sh script to our centos7.img container. Let&#8217;s try executing that script with the following command:</p>
<code> [test_user@comet-ln3 &#126;]$ singularity exec /oasis/scratch/comet/test_user/temp_project/singularity/centos7.img /hello_world.sh </code>
<p>If all goes well,&#194; you should see &#8220;Hello, World!&#8221; in the console output. You might also see some warnings pertaining to non-existent bind points. You can resolve this by adding some additional lines to your definitions file before you build your container. We did not do that for this tutorial, but you would use a command like the following in your definitions file:</p>
<code># create bind points for SDSC HPC environment<br/> mkdir /oasis /scratch/ /comet /temp_project</code>
<p>You will find additional examples located in the following locations on Comet:</p>
<code>/share/apps/examples/SI2017/Singularity </code>
<p>and</p>
<code>/share/apps/examples/SINGULARITY</code>
<p>&#160;</p>
<h2>Allocate Resources to Run the Container</h2>
<p><a href="https://asciinema.org/a/130197" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>It is best to avoid working on Comet&#8217;s login nodes since they can become a performance bottleneck not only for you but for all other users. You should rather allocate resources specific for computationally-intensive jobs. To allocate a &#8216;compute node&#8217; for your user on Comet, issue the following command:</p>
<code>[test_user@comet-ln3 &#126;]$ salloc -N 1 -t 00:10:00</code>
<p>This allocation requests a single node (-N 1) for a total time of 10 minutes (-t 00:10:00). Once your request has been approved, your computer node name should be displayed, e.g. comet-17-12.</p>
<p>Now you may login to this node:</p>
<code><code>[test_user@comet-ln3 &#126;]$ ssh comet-17-12</code></code>
<p>Notice that the command prompt has now changed to reflect the fact that you are on a compute node and not a login node.</p>
<code><code><code>[test_user@comet-06-04 &#126;]$ </code></code></code>
<p>Next, load the Singularity module, shell into the container, and execute the hello_world.sh script:</p>
<code><code><code>[test_user@comet-06-04 &#126;]$ module load singularity<br/> [test_user@comet-06-04 &#126;]$ singularity shell centos7.img<br/> [test_user@comet-06-04 &#126;]$ ./hello_world.sh</code></code></code>
<p>If all goes well, you should see &#8220;Hello, World!&#8221; in the console output.</p>
<p>&#160;</p>
<h2>Integrate the Container with Slurm</h2>
<p><a href="https://asciinema.org/a/130218" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Of course, most users simply want to submit their jobs to the Comet queue and let it run to completion and go on to other things while waiting. Slurm is the job manager for Comet.</p>
<p>Below is a job script (which we will name singularity_mvapich2_hellow.run) which will submit your Singularity container to the Comet queue and run a program, hellow.c (written in C using MPI and provided as part of the examples with the mvapich2 default installation).</p>
<p><code> #!/bin/bash </code><code><br/> #SBATCH --job-name="singularity_mvapich2_hellow" <br/> #SBATCH --output="singularity_mvapich2_hellow.%j.out" <br/> #SBATCH --error="singularity_mvapich2_hellow.%j.err" <br/> #SBATCH --nodes=2 <br/> #SBATCH --ntasks-per-node=24 <br/> #SBATCH --time=00:10:00 <br/> #SBATCH --export=all </code> <code> module load mvapich2_ib singularity </code></p>
<p><code> CONTAINER=/oasis/scratch/comet/$USER/temp_project/singularity/centos7-mvapich2.img </code></p>
<p><code> mpirun singularity exec ${CONTAINER} /usr/bin/hellow </code></p>
<p>The above script requests 2 nodes and 24 tasks per node with a wall time of 10 minutes. Notice that two modules are loaded (see the line beginning with &#8216;module&#8217;), one for Singularity and one for MPI. An environment variable &#8216;CONTAINER&#8217; is also defined to make it a little easier to manage long reusable text strings such as file paths.</p>
<p>You may need to add a line specifying with allocation to be used for this job. When you are ready to submit the job to the Comet queue, issue the following command:</p>
<code><code><code>[test_user@comet-06-04 &#126;]$ sbatch -p debug ./singularity_mvapich2_hellow.run</code></code></code>
<p>To view the status of your job in the Comet queue, issue the following:</p>
<code><code><code>[test_user@comet-06-04 &#126;]$ squeue -u test_user</code></code></code>
<p>When the job is complete, view the output which should be written to the output file singularity_mvapich2_hellow.%j.out where %j is the job ID (let&#8217;s say the job ID is 1000001):</p>
<code><code><code>[test_user@comet-06-04 &#126;]$ more singularity_mvapich2_hellow.1000001.out</code></code></code>
<p>The output should look something like the following: <br/> <code> . <br/> . <br/> . <br/> Hello world from process 28 of 48 <br/> Hello world from process 29 of 48 <br/> Hello world from process 30 of 48 <br/> Hello world from process 31 of 48 <br/> Hello world from process 32 of 48 <br/> Hello world from process 33 of 48 <br/> Hello world from process 34 of 48 <br/> Hello world from process 35 of 48 <br/> Hello world from process 36 of 48 <br/> Hello world from process 37 of 48 <br/> Hello world from process 38 of 48 <br/> . <br/> .<br/></code><code>.</code></p>
<p>&#160;</p>
<h2>Use Existing Comet Containers</h2>
<p>SDSC User Support staff, Marty Kandes, has built several custom Singularity containers designed specifically for the Comet environment.&#160;</p>
<p><a href="about_comet_singularity_containers.html">Learn more about these containers for Comet</a>.&#160;</p>
<p><code>&#160;</code></p>
<p><span style="color: #d31820; font-family: Tauri, sans-serif; font-size: 30px;">News Flash!</span></p>
<p>Now there's an easier way to run a Singularity container on Comet...</p>
<h2>PULL IT!</h2>
<p><a href="https://asciinema.org/a/129906" target="new"><img alt="" class="video_icon" height="86" src="http://education.sdsc.edu/comet/assets/images/video_tutorial_icon.png" style="float: right;" width="111"/></a>Comet now supports the capability to pull a container directly from any properly configured remote singularity hub. For example, the following command can pull a container from the hpcdevops singularity hub straight to an empty container located on Comet:</p>
<code><code><code>[test_user@comet-06-04 &#126;]$ singularity pull shub://hpcdevops/singularity-hello-world:master</code></code></code>
<p>The resulting container should be named something like singularity-hello-world.img.</p>
<p>Learn more about Singularity Hubs and container collections at:</p>
<p><a href="https://singularity-hub.org/collections" target="new">https://singularity-hub.org/collections</a></p>
<p>That's it! Congratulations! You should now be able to run Singularity containers on Comet either interactively or through the job queue. We hope you found this tutorial useful. Please contact <a href="mailto:support@xsede.org">support@xsede.org</a> with any questions you might have. Your Comet-related questions will be routed to the amazing SDSC Support Team.</p>
<h1>Using Tensorflow With Singularity</h1>
<p>One of the more common advantages of using Singularity is the ability to use pre-built containers for specific applications which may be difficult to install and maintain by yourself, such as Tensorflow. The most common example of a Tensorflow application is character recognition using the MNIST dataset. You can learn more about this dataset at <a href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a>.</p>
<p>XSEDE's Comet supercomputer supports Singularity and provides several pre-built container which run Tensorflow. Below is an example batch script which runs a Tensorflow job within a Singularity container on Comet. Copy this script and paste it into a shell script named "mnist_tensorflow_example.sb".</p>
<p>#!/bin/bash<br/> #SBATCH --job-name="TensorFlow"<br/> #SBATCH --output="TensorFlow.%j.%N.out"<br/> #SBATCH --partition=gpu-shared<br/> #SBATCH --nodes=1<br/> #SBATCH --ntasks-per-node=6<br/> #SBATCH --gres=gpu:k80:1<br/> #SBATCH -t 01:00:00</p>
<p>#Run the job</p>
<p>module load singularity<br/> singularity exec /share/apps/gpu/singularity/sdsc_ubuntu_gpu_tflow.img lsb_release -a<br/> singularity exec /share/apps/gpu/singularity/sdsc_ubuntu_gpu_tflow.img python -m tensorflow.models.image.mnist.convolutional</p>
<p>To submit the script to Comet, first you'll need to request a compute node with the following command (replace account with your XSEDE account number):</p>
<p><code>[test_user@comet-ln3 &#126;]$ srun --account=your_account_code --partition=gpu-shared --gres=gpu:1 --pty --nodes=1 --ntasks-per-node=1 -t 00:30:00 --wait=0 --export=ALL /bin/bash</code></p>
</div>
</div>
<div section="class">
<p>To submit a job to the Comet queue, issue the following command:</p>
<p><code>[test_user@comet-06-04 &#126;]$ sbatch mnist_tensorflow_example.sb</code></p>
<p>When the job is done you should see an output file in your output directory containing something resembling the following:</p>
<p><code>Distributor ID: Ubuntu<br/> Description: Ubuntu 16.04 LTS<br/> Release: 16.04<br/> Codename: xenial<br/> ^[[33mWARNING: Non existent bind point (directory) in container: '/scratch'<br/> ^[[0mI tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcublas.so locally<br/> I tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcudnn.so locally<br/> I tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcufft.so locally<br/> I tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcuda.so.1 locally<br/> I tensorflow/stream_executor/dso_loader.cc:108] successfully opened CUDA library libcurand.so locally<br/> I tensorflow/core/common_runtime/gpu/gpu_init.cc:102] Found device 0 with properties:<br/> name: Tesla K80<br/> major: 3 minor: 7 memoryClockRate (GHz) 0.8235<br/> pciBusID 0000:85:00.0<br/> Total memory: 11.17GiB<br/> Free memory: 11.11GiB<br/> I tensorflow/core/common_runtime/gpu/gpu_init.cc:126] DMA: 0<br/> I tensorflow/core/common_runtime/gpu/gpu_init.cc:136] 0: Y<br/> I tensorflow/core/common_runtime/gpu/gpu_device.cc:838] Creating TensorFlow device (/gpu:0) -&gt; (device: 0, name: Tesla K80, pci bus id: 0000:85:00.0)<br/> Extracting data/train-images-idx3-ubyte.gz<br/> Extracting data/train-labels-idx1-ubyte.gz<br/> Extracting data/t10k-images-idx3-ubyte.gz<br/> Extracting data/t10k-labels-idx1-ubyte.gz<br/> Initialized!<br/> Step 0 (epoch 0.00), 40.0 ms<br/> Minibatch loss: 12.054, learning rate: 0.010000<br/> Minibatch error: 90.6%<br/> Validation error: 84.6%<br/> Step 100 (epoch 0.12), 12.6 ms<br/> Minibatch loss: 3.293, learning rate: 0.010000<br/> Minibatch error: 6.2%<br/> Validation error: 7.0%</code></p>
<p>.</p>
<p>.</p>
<p>.</p>
<p><code>Step 8400 (epoch 9.77), 11.5 ms<br/> Minibatch loss: 1.596, learning rate: 0.006302<br/> Minibatch error: 0.0%<br/> Validation error: 0.9%<br/> Step 8500 (epoch 9.89), 11.5 ms<br/> Minibatch loss: 1.593, learning rate: 0.006302<br/> Minibatch error: 0.0%<br/> Validation error: 0.8%<br/> Test error: 0.9%</code></p>
<p>Congratulations! You have successfully trained a neural network to recognize ascii numeric characters.</p>
<p>&#160;</p>
<p>&#160;</p>
</div>
<style type="text/css"><!--
p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo}
span.s1 {font-variant-ligatures: no-common-ligatures}
--></style></div></section><aside><div data-col="2"><div class="section">
<h2>Contact Us</h2>
<p><a href="mailto:help@xsede.org">help@xsede.org</a></p>
</div></div></aside>
            </div><!-- END: INNER -->
        </div><!-- END: SUB-CONTENT -->

        <!-- Breadcrumbs -->
        

    </div><!-- END: LAYOUT -->
</div><!-- END: CONTENT -->

<!-- Footer -->
<div id="footer"><!-- Footer --><footer role="contentinfo">
<div class="clearfix" data-footer="">
<div data-row="6" id="footer-nav-links">
<div data-inner="">
<div id="btn-donate"><a href="https://giveto.ucsd.edu/make-a-gift?id=8edd15bf-4db1-4c58-975b-7d8ccae8b4ff" rel="noopener" target="_blank"><img alt="donate" height="81" src="../../../assets/images/btn-donate.png" width="80"/></a></div>
<div data-col="1"><!-- Footer Navigation --><nav role="navigation">
<p data-nostyle="">Site 'Footer' Navigation:</p>
<h3><a href="../../../services/index.html">SDSC<br/> Services</a></h3>
<ul class="nav-footer" data-nav="">
<li><a href="../../../services/hpc/index.html">High-Performance Computing</a></li>
<li><a href="../../../services/data_science/index.html">Data Science Solutions</a></li>
<li><a href="../../../services/ci/index.html">Cyberinfrastructure Services</a></li>
<li><a href="../../../services/business_services/index.html">Business Services</a></li>
</ul>
</nav></div>
<div data-col="1"><!-- Footer Navigation --><nav role="navigation">
<p data-nostyle="">Site 'Footer' Navigation:</p>
<h3><a href="../../index.html">SDSC<br/> Support</a></h3>
<ul class="nav-footer" data-nav="">
<li><a href="../../accounts_allocations.html">Accounts &amp; Allocations</a></li>
<li><a href="../../resource_docs.html">Resource Documentation</a></li>
<li><a href="../../technical_support.html">Technical Consulting</a></li>
<li><a href="../../status.html">System News &amp; Status</a></li>
</ul>
</nav></div>
<div data-col="1"><!-- Footer Navigation --><nav role="navigation">
<p data-nostyle="">Site 'Footer' Navigation:</p>
<h3><a href="../../../research/index.html">Research &amp;<br/> Development</a></h3>
<ul class="nav-footer" data-nav="">
<li><a href="../../../research/centers_of_excellence.html">Centers of Excellence</a></li>
<li><a href="../../../research/groups_labs_projects.html">Groups, Labs, &amp; Projects</a></li>
<li><a href="../../../research/collaboration.html">Collaboration</a></li>
</ul>
</nav></div>
<div data-col="1"><!-- Footer Navigation --><nav role="navigation">
<p data-nostyle="">Site 'Footer' Navigation:</p>
<h3><a href="../../../education_and_training/index.html">Education &amp;<br/> Training</a></h3>
<ul class="nav-footer" data-nav="">
<li><a href="../../../education_and_training/camps_workshops.html">Camps &amp; Workshops</a></li>
<li><a href="../../../education_and_training/courses_degrees.html">Courses &amp; Degree Programs</a></li>
<li><a href="../../../education_and_training/training.html">Advanced Computing Training</a></li>
<li><a href="../../../education_and_training/webinars.html">Webinars</a></li>
<li><a href="../../../education_and_training/internships.html">Internships</a></li>
</ul>
</nav></div>
<div data-col="1"><!-- Footer Navigation --><nav role="navigation">
<p data-nostyle="">Site 'Footer' Navigation:</p>
<h3><a href="../../../news_and_events/index.html">News &amp;<br/> Events</a></h3>
<ul class="nav-footer" data-nav="">
<li><a href="../../../news_and_events/news_list_recent.html">Press Releases</a></li>
<li><a href="../../../news_and_events/events.html">Events</a></li>
<li><a href="../../../news_and_events/in_the_news.html">In The News</a></li>
<li><a href="../../../news_and_events/newsletter.html">Newsletter</a></li>
<li><a href="../../../news_and_events/meet_the_experts.html">"Meet the Experts"</a></li>
<li><a href="../../../pub/index.html">Publications</a></li>
<li><a href="../../../news_and_events/press_kit.html">Press Kit</a></li>
</ul>
</nav></div>
<div data-col="1"><!-- Footer Navigation --><nav role="navigation">
<p data-nostyle="">Site 'Footer' Navigation:</p>
<h3><a href="../../../about_sdsc/index.html">About<br/> SDSC</a></h3>
<ul class="nav-footer" data-nav="">
<li><a href="../../../about_sdsc/overview.html">Overview</a></li>
<li><a href="../../../assets/docs/pub/sdsc_timeline_web.pdf" rel="noopener" target="_blank">Timeline</a></li>
<li><a href="../../../about_sdsc/director.html">About the Director</a></li>
<li><a href="../../../about_sdsc/contacts_leadership.html">Contacts &amp; Leadership</a></li>
<li><a href="/cgi-bin/staff_dir.cgi">Staff Directory</a></li>
<li><a href="../../../about_sdsc/careers.html">Careers</a></li>
<li><a href="../../../about_sdsc/visitor_info.html">Visitor Info</a></li>
</ul>
</nav></div>
</div>
</div>
<div data-row="6" id="footer-copyright">
<div data-inner="">
<ul class="list-social">
<li class="social"><a data-icon-full="facebook" href="https://www.facebook.com/SanDiegoSupercomputerCenter" rel="noopener" target="_blank">Facebook</a></li>
<li class="social"><a data-icon-full="twitter" href="https://twitter.com/SDSC_UCSD" rel="noopener" target="_blank">Twitter</a></li>
<!--
<li class="social"><a data-icon-full="google+" href="https://plus.google.com/" target="_blank">Google+</a></li>
-->
<li class="social"><a data-icon-full="linkedin" href="https://www.linkedin.com/company/san-diego-supercomputer-center" rel="noopener" target="_blank">LinkedIn</a></li>
<li class="social"><a data-icon-full="flickr" href="https://www.flickr.com/photos/75819710@N05/" rel="noopener" target="_blank">Flickr</a></li>
<li class="social"><a data-icon-full="youtube" href="https://www.youtube.com/channel/UC7Gm75ukCI8FW_w6F8tAWLg" rel="noopener" target="_blank">YouTube</a></li>
</ul>
<p id="address">SDSC - UC San Diego, MC 0505 | 9500 Gilman Drive | La Jolla, CA 92093-0505</p>
<p id="contact-info">Tel. (858) 534-5000 | Fax. (858) 534-5152 | <a href="mailto:info@sdsc.edu">info@sdsc.edu</a> | <a href="../../../terms_of_use.html">Terms of Use</a> | <a href="../../../privacy.html">Privacy Policy</a> | <a href="../../../about_sdsc/sitemap.html">Sitemap</a> | <a href="javascript:void(0);" onclick="feedback_window('Comment')">Got feedback?</a></p>
<p id="copyright">&#169; 2018, The Regents of the University of California</p>
</div>
</div>
</div>
</footer></div>
<script src="../../../assets/scripts/jquery-1.11.2.js" type="text/javascript">
</script>
<script src="../../../assets/scripts/common.js" type="text/javascript">
</script>
</body>
</html>